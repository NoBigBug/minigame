<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Squid Game - Final Chaos</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background: #000; }
        #ui { position: absolute; top: 20px; width: 100%; text-align: center; color: white; pointer-events: none; z-index: 10; }
        #status { font-size: 2.2rem; font-weight: bold; text-shadow: 2px 2px 5px rgba(0,0,0,0.7); padding: 15px 25px; border-radius: 15px; display: inline-block; }
        .red-text { color: #ff4757; background: rgba(255, 0, 0, 0.6); border: 3px solid #ff4757; box-shadow: 0 0 30px #ff0000; }
        .green-text { color: #2ed573; background: rgba(0, 0, 0, 0.4); }
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,0,0,0.2); flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100; backdrop-filter: blur(5px); }
        #startScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 200; flex-direction: column; color: white; }
        #startBtn { padding: 20px 50px; font-size: 2rem; cursor: pointer; background: #ff4757; color: white; border: none; border-radius: 10px; font-weight: bold; }
        #retryBtn { margin-top: 20px; padding: 15px 40px; font-size: 1.2rem; cursor: pointer; border: none; border-radius: 5px; background: white; font-weight: bold; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1>3D SQUID GAME</h1>
        <p>Í≤ΩÏüÅÏûêÎì§Í≥º Ìï®Íªò ÏÇ¥ÏïÑÎÇ®ÏúºÏÑ∏Ïöî!</p>
        <button id="startBtn">Í≤åÏûÑ ÏãúÏûë</button>
    </div>

    <div id="ui"><div id="status" class="green-text">READY</div></div>

    <div id="overlay">
        <h1 id="resTitle" style="font-size: 5rem; text-shadow: 5px 5px 0px #000;">ELIMINATED!</h1>
        <button id="retryBtn" onclick="location.reload()">Îã§Ïãú ÎèÑÏ†Ñ</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // 1. Í∏∞Î≥∏ ÏÑ§Ï†ï
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87ceeb);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        scene.add(new THREE.AmbientLight(0xffffff, 0.7));
        const light = new THREE.DirectionalLight(0xffffff, 1.2);
        light.position.set(5, 20, 10);
        scene.add(light);

        const startZ = 100; const goalZ = -60; const dollZ = -85;

        // Î∞îÎã• Î∞è Î≤Ω
        const floor = new THREE.Mesh(new THREE.PlaneGeometry(60, 400), new THREE.MeshStandardMaterial({ color: 0xe3c193 }));
        floor.rotation.x = -Math.PI / 2; scene.add(floor);
        const colors = [0xff6b6b, 0x4ecdc4, 0xffe66d, 0x1a535c, 0xff9ff3, 0x54a0ff];
        for(let x of [-25, 25]) {
            for(let z = -150; z < 150; z += 6) {
                for(let y = 0.5; y < 12; y += 1.8) {
                    const block = new THREE.Mesh(new THREE.BoxGeometry(2, 1.6, 5), new THREE.MeshStandardMaterial({ color: colors[Math.floor(Math.random()*6)] }));
                    block.position.set(x, y, z); scene.add(block);
                }
            }
        }

        // Í±∞ÎåÄ Ïà†Îûò
        const dollGroup = new THREE.Group();
        dollGroup.add(new THREE.Mesh(new THREE.BoxGeometry(5, 8, 3), new THREE.MeshStandardMaterial({color: 0xff4757})));
        const head = new THREE.Mesh(new THREE.BoxGeometry(4, 4, 4), new THREE.MeshStandardMaterial({color: 0xffccaa}));
        head.position.y = 6; dollGroup.add(head);
        dollGroup.position.set(0, 4, dollZ);
        scene.add(dollGroup);

        // ÌîåÎ†àÏù¥Ïñ¥
        const player = new THREE.Mesh(new THREE.SphereGeometry(1, 32, 32), new THREE.MeshStandardMaterial({ color: 0x0061ff }));
        player.position.set(0, 1, startZ); scene.add(player);

        // --- üèÉ NPC Í≤ΩÏüÅÏûê ÏÉùÏÑ± ---
        const npcs = [];
        for(let i=0; i < 12; i++) {
            const npc = new THREE.Mesh(new THREE.SphereGeometry(1, 24, 24), new THREE.MeshStandardMaterial({ color: 0x27ae60 }));
            npc.position.set((Math.random() - 0.5) * 40, 1, startZ + (Math.random() * 10));
            npc.userData = { alive: true, speed: 0.04 + Math.random() * 0.12 };
            scene.add(npc);
            npcs.push(npc);
        }

        // 2. Ìö®Í≥º Î°úÏßÅ (Ï¥ùÍ≤©)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playGunShot() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        function createLaser(targetPos) {
            const fromX = (Math.random() > 0.5 ? -24 : 24);
            const fromY = 2 + Math.random() * 10;
            const fromZ = targetPos.z + (Math.random() - 0.5) * 5;
            const pts = [new THREE.Vector3(fromX, fromY, fromZ), targetPos.clone()];
            const laser = new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), new THREE.LineBasicMaterial({ color: 0xff0000 }));
            scene.add(laser);
            setTimeout(() => scene.remove(laser), 150);
        }

        // 3. Í≤åÏûÑ ÏóîÏßÑ
        let isRedLight = true; let gameOver = true;
        const statusEl = document.getElementById('status');

        function toggleLight() {
            if (gameOver) return;
            isRedLight = false;
            statusEl.textContent = "üèÉ GREEN LIGHT"; statusEl.className = "green-text";
            dollGroup.rotation.y = Math.PI;

            const chant1 = new SpeechSynthesisUtterance("Î¨¥Í∂ÅÌôî ÍΩÉÏù¥");
            const chant2 = new SpeechSynthesisUtterance("ÌîºÏóàÏäµÎãàÎã§");
            chant1.lang = chant2.lang = 'ko-KR';
            chant1.rate = 0.5 + Math.random() * 0.6; chant2.rate = 1.8 + Math.random() * 1.5;

            chant1.onend = () => { if (!gameOver) window.speechSynthesis.speak(chant2); };
            chant2.onend = () => {
                if (gameOver) return;
                isRedLight = true;
                statusEl.textContent = "üõë RED LIGHT"; statusEl.className = "red-text";
                dollGroup.rotation.y = 0;

                // Îπ®Í∞ÑÎ∂àÏù¥ ÏºúÏßÑ ÏßÅÌõÑ NPC ÏÉùÏ°¥ ÌåêÏ†ï
                setTimeout(() => {
                    npcs.forEach(npc => {
                        if (npc.userData.alive && isRedLight && Math.random() < 0.4) {
                            npc.userData.alive = false;
                            for(let j=0; j<3; j++) setTimeout(() => { playGunShot(); createLaser(npc.position); }, j*100);
                            setTimeout(() => { npc.material.color.set(0x333333); npc.scale.y = 0.2; }, 300);
                        }
                    });
                }, 200);

                setTimeout(toggleLight, 1500 + Math.random() * 1500);
            };
            window.speechSynthesis.speak(chant1);
        }

        function handleStep() {
            if (gameOver) return;
            if (isRedLight) {
                for(let i=0; i<10; i++) setTimeout(() => { playGunShot(); createLaser(player.position); }, i*50);
                player.material.color.set(0x000000);
                endGame(false);
            } else {
                player.position.z -= 2.2;
                camera.position.set(player.position.x, player.position.y + 7, player.position.z + 14);
                camera.lookAt(0, 3, player.position.z - 20);
                if (player.position.z <= goalZ) endGame(true);
            }
        }

        document.getElementById('startBtn').addEventListener('click', (e) => {
            e.stopPropagation(); document.getElementById('startScreen').style.display = 'none';
            gameOver = false; toggleLight(); animate();
        });

        window.addEventListener('mousedown', handleStep);
        window.addEventListener('touchstart', (e) => { if(!gameOver) { e.preventDefault(); handleStep(); } }, { passive: false });

        function animate() {
            if (gameOver && document.getElementById('overlay').style.display === 'flex') return;
            requestAnimationFrame(animate);
            if (!isRedLight) {
                dollGroup.rotation.y = THREE.MathUtils.lerp(dollGroup.rotation.y, Math.PI, 0.1);
                npcs.forEach(n => { if(n.userData.alive && n.position.z > goalZ) n.position.z -= n.userData.speed; });
            }
            renderer.render(scene, camera);
        }

        function endGame(success) {
            gameOver = true; window.speechSynthesis.cancel();
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('resTitle').textContent = success ? "SUCCESS! üéâ" : "ELIMINATED! üî´";
        }
    </script>
</body>
</html>
